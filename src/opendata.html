<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sankey Diagram - Open Food Facts</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-array@1"></script>
    <script src="https://unpkg.com/d3-collection@1"></script>
    <script src="https://unpkg.com/d3-path@1"></script>
    <script src="https://unpkg.com/d3-shape@1"></script>
    <script src="https://unpkg.com/d3-sankey@0"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      #sankey-container {
        width: 100%;
        height: 100%;
        margin: 0 auto;
      }
      svg {
        border: 1px solid #ccc;
      }
      .node rect {
        fill: #3182bd;
        stroke: #000;
      }
      .link {
        fill: none;
        stroke-opacity: 0.7;
      }
      .node text {
        display: none;
      }
      .node:hover text {
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>Sankey Diagram - Open Food Facts</h1>
    <div id="sankey-container"></div>
    <script src="data/countries_to_regions_table.js" type="text/javascript"></script>
    <script src="data/countries_to_subregions_table.js" type="text/javascript"></script>
    <script src="data/subregions_to_regions_table.js" type="text/javascript"></script>
    <script src="data/subregions_to_countries_table.js" type="text/javascript"></script>
    <script src="data/regions_to_countries_table.js" type="text/javascript"></script>
    <script src="data/regions_to_subregions_table.js" type="text/javascript"></script>
    <script src="data/clean_data.js" type="text/javascript"></script>
    <script>

      // Set up the SVG container
      const width = 1600;
      const height = 600;
      const svg = d3
        .select("#sankey-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      // Create Sankey generator
      const sankey = d3
        .sankey()
        .nodeWidth(20)
        .nodePadding(15)
        .size([width - 41, height - 41]);

    
      let nodeIndex = 0;
      const nodes = [];
      const nodeIndexMap = new Map();

      function nodeUniqueName(name, type){
        return `${type}:${name}`
      }

      // Helper function to add nodes and create a unique index for each
      function addNode(name, type) {
        // get unique name
        const uniqueName = nodeUniqueName(name, type);

        // increase the value of the node if it already exist
        if (nodeIndexMap.has(uniqueName)) {
          nodes[nodeIndexMap.get(uniqueName)].value += 1;
          return
        }

        // create a node if it do not exist          
        nodes.push({ name:uniqueName, country:name, type:type, value: 1});
        nodeIndexMap.set(uniqueName, nodeIndex);
        nodeIndex += 1;
        //console.log(`Adding node : ${uniqueName}`);
        return
      }

      let linkIndex = 0;
      const links = [];
      const linkIndexMap = new Map();

      function linkUniqueName(node1UniqueName, node2UniqueName){
        return `${node1UniqueName} -> ${node2UniqueName}`
      }

      function addLink(name1, type1, name2, type2) {
        // get unique name
        const node1UniqueName = nodeUniqueName(name1, type1);
        const node2UniqueName = nodeUniqueName(name2, type2);
        const uniqueName = linkUniqueName(node1UniqueName, node2UniqueName);
        
        // increase the value of the link if it already exist
        if (linkIndexMap.has(uniqueName)) {
          links[linkIndexMap.get(uniqueName)].value += 1;
          return;
        }

        // create a link if it do not exist
        links.push({ source:nodeIndexMap.get(node1UniqueName), target:nodeIndexMap.get(node2UniqueName), type:type2, value: 1 });
        linkIndexMap.set(uniqueName, linkIndex);
        linkIndex += 1;
        //console.log(`Adding link : ${uniqueName}`); 
        return;
      }

      const PRODUCT_TYPE = "product";
      const ORIGIN_TYPE = "origin";
      const MANUFACTURING_PLACE_TYPE = "manu";
      const COUNTRY_TYPE = "country";

      products.map((product) => {

        if (!product.product_name) return;
        if (!product.origins_tags_std) return;
        if (!product.manufacturing_places_tags_std) return;
        if (!product.countries_tags_std) return;

        // adding Nodes
        //addNode(product.product_name, PRODUCT_TYPE);

        product.origins_tags_std.forEach((origin) => {
          addNode(countries_to_regions[origin], ORIGIN_TYPE);
        });

        product.manufacturing_places_tags_std.forEach((manu) => {
          addNode(countries_to_regions[manu], MANUFACTURING_PLACE_TYPE);
        });

        product.countries_tags_std.forEach((country) => {
          addNode(countries_to_regions[country], COUNTRY_TYPE)
        });

        // adding Links

        //product.origins_tags_std.forEach((origin) => {
        //  addLink(product.product_name, PRODUCT_TYPE, origin, ORIGIN_TYPE);
        //});

        product.origins_tags_std.forEach((origin) =>{ 
          product.manufacturing_places_tags_std.forEach((manu) =>{
            addLink(countries_to_regions[origin], ORIGIN_TYPE, countries_to_regions[manu], MANUFACTURING_PLACE_TYPE);
          });
        });

        product.manufacturing_places_tags_std.forEach((manu) =>{
          product.countries_tags_std.forEach((country) =>{
            addLink(countries_to_regions[manu], MANUFACTURING_PLACE_TYPE, countries_to_regions[country], COUNTRY_TYPE);
          });
        });

      });



      // Generate the Sankey diagram
      const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
        nodes: nodes.map((d) => Object.assign({}, d)),
        links: links.map((d) => Object.assign({}, d)),
      });

      // Set node positions based on type to separate columns
      sankeyNodes.forEach((node) => {
        if (node.type === PRODUCT_TYPE) {
          node.x0 = 0;
          node.x1 = sankey.nodeWidth();
        } else if (node.type === ORIGIN_TYPE) {
          node.x0 = width / 4;
          node.x1 = width / 4 + sankey.nodeWidth();
        } else if (node.type === MANUFACTURING_PLACE_TYPE) {
          node.x0 = (2 * width) / 4;
          node.x1 = (2 * width) / 4 + sankey.nodeWidth();
        } else if (node.type === COUNTRY_TYPE) {
          node.x0 = (3 * width) / 4;
          node.x1 = (3 * width) / 4 + sankey.nodeWidth();
        }
      });

      // Draw links
      svg
        .append("g")
        .selectAll("path")
        .data(sankeyLinks)
        .join("path")
        .attr("class", "link")
        .attr("d", d3.sankeyLinkHorizontal())
        .attr("stroke-width", (d) => d.width)
        .attr("stroke", (d) => {
          if (d.type === ORIGIN_TYPE) {
            return "#ff7f0e";
          } else if (d.type === MANUFACTURING_PLACE_TYPE) {
            return "#2ca02c";
          } else if (d.type === COUNTRY_TYPE) {
            return "#1f77b4";
          } else {
            return "#6baed6";
          }
        });

      // Draw nodes
      const node = svg
        .append("g")
        .selectAll("g")
        .data(sankeyNodes)
        .join("g")
        .attr("class", "node");
        

      node
        .append("rect")
        .attr("x", (d) => d.x0)
        .attr("y", (d) => d.y0)
        .attr("height", (d) => Math.max(1, d.y1 - d.y0))
        .attr("width", (d) => 20)
        .attr("stroke", (d) => {
          if (d.type === ORIGIN_TYPE) {
            return "#ff7f0e";
          } else if (d.type === MANUFACTURING_PLACE_TYPE) {
            return "#2ca02c";
          } else if (d.type === COUNTRY_TYPE) {
            return "#1f77b4";
          } else {
            return "#6baed6";
          }
        });

      // Add labels (hidden by default, shown on hover)
      node
        .append("text")
        .attr("x", (d) => d.x0 - 6)
        .attr("y", (d) => (d.y1 + d.y0) / 2)
        .attr("dy", "0.35em")
        .attr("text-anchor", "end")
        .text((d) => d.name)
        .filter((d) => d.x0 < width / 2)
        .attr("x", (d) => d.x1 + 6)
        .attr("text-anchor", "start");
      
    </script>
  </body>
</html>
